---
- name: Verify
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: SmokeTests
      ansible.builtin.debug:
        msg:
          - "ansible_version => {{ansible_version}}"
          - "ansible_distribution => {{ ansible_distribution }}"
          - "ansible_distribution_major_version => {{ ansible_distribution_major_version }}"
          - "ansible_os_family  => {{ ansible_os_family}}"
          - "ansible_system  => {{ ansible_system }}"

    # Repository
    - name: Test if Debian repository exists
      ansible.builtin.lineinfile:
        name: '/etc/apt/sources.list.d/nginx.list'
        line: '# Ansible managed: Do NOT edit this file manually!'
        state: present
      check_mode: true
      register: nginx_repository
      failed_when: (nginx_repository is changed) or (nginx_repository is failed)
      when: ansible_os_family == "Debian"

    - name: Test if RedHat repository exists
      ansible.builtin.lineinfile:
        name: '/etc/yum.repos.d/nginx.repo'
        line: '# Ansible managed: Do NOT edit this file manually!'
        state: present
      check_mode: true
      register: nginx_repository
      failed_when: (nginx_repository is changed) or (nginx_repository is failed)
      when: ansible_os_family == "RedHat"

    # nginx
    - name: Test /etc/nginx/nginx.conf config is generated
      ansible.builtin.lineinfile:
        name: '/etc/nginx/nginx.conf'
        line: 'error_log  /var/log/nginx/error.log notice;'
        state: present
      check_mode: true
      register: nginx_conf
      failed_when: (nginx_conf is changed) or (nginx_conf is failed)

    - name: Test /etc/nginx/conf.d/default.conf config is generated
      ansible.builtin.lineinfile:
        name: '/etc/nginx/conf.d/default.conf'
        line: '    return 301 https://$host$request_uri;'
        state: present
      check_mode: true
      register: nginx_conf
      failed_when: (nginx_conf is changed) or (nginx_conf is failed)

    - name: Test /etc/nginx/streams.conf config is generated
      ansible.builtin.lineinfile:
        name: '/etc/nginx/streams.conf'
        line: '    upstream dns_servers {'
        state: present
      check_mode: true
      register: streams_conf
      failed_when: (streams_conf is changed) or (streams_conf is failed)

    - name: Test if nginx is installed
      ansible.builtin.package:
        name: "nginx"
        state: present
      check_mode: true
      register: nginx_package
      failed_when: (nginx_package is changed) or (nginx_package is failed)

    - name: Test if nginx is started
      ansible.builtin.service:
        name: "nginx"
        state: started
      check_mode: true
      register: nginx_service
      failed_when: (nginx_service is changed) or (nginx_service is failed)
